<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Timezone Map</title>
    <style>
        .background {
            margin-left: calc((100%)/5);
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            background: lavender;
        }

        .path {
            fill: none;
            stroke: #fff;
        }

        .country {
            stroke: #000;
        }

        .tooltip {
            color: #222;
            background: #fff;
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            box-shadow: 0px 0px 2px 0px #a6a6a6;
            opacity: 0.9;
            position: absolute;
        }

        table {
            margin-left: 26%;
            float: left;
        }

        thead {
            font-size: 22px;
            text-align: center;
        }

        td {
            width: 85px;
            font-size: 17px;
            padding-top: 2px;
            padding-bottom: 2px;
            height: 20px;
            text-align: center;
        }

        .active {
            outline: #000 solid;
        }

        .grey {
            fill: lightgrey !important;
        }
    </style>
</head>

<body>
    <script src="//code.jquery.com/jquery-2.0.0.js"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script>
        var w = 1150,
            h = 540;

        var projection = d3.geo.mercator()
            .translate([w / 2, h / 2])
            .scale(200);

        var color = d3.scale.category20(); //20 color scale

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select('body')
            .append('svg')
            .attr('width', w)
            .attr('height', h)
            .attr('class', 'background')
            .call(d3.behavior.zoom()
                .on('zoom', redraw))
            .append('g');

        var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');


        function redraw() {
            var s = d3.event.scale;
            var t = d3.event.translate;

            svg.style("stroke-width", 1 / s).attr("transform",
                "translate(" + t + ")scale(" + s + ")");
        }

        var new_dic = [],
            text_timezone = 'UTC TimeZone';
        d3.json('timezones.topo.json', function(error, data) {
            if (error) console.log(error);

            svg.selectAll('path')
                .data(topojson.feature(data, data.objects.timezones).features)
                .enter()
                .append('path')
                .attr('class', function(d) {
                    var item = d.properties.Name.replace(/[A-Za-z ]/g, "");
                    if (new_dic.indexOf(item) == -1) {
                        new_dic.push(item);
                    }
                    return 'path country ' + 'color_' + color(d.properties.Name.replace(/[A-Za-z ]/g, "")).slice(1, 7);
                })
                .attr('title', function(d) {
                    return d.properties.Name;
                })
                .style('fill', function(d) {
                    return color(d.properties.Name.replace(/[A-Za-z ]/g, ""));
                })
                .attr('d', path)
                .on("mouseleave", function () {
                   var clas = $(this).attr('class');
                   var not_area = svg.selectAll('.country');
                   not_area.classed('grey', false);

                   d3.selectAll($(this)).style('fill', '#' + clas.split('_')[1]);
                   tooltip.classed('hidden', false);
                   d3.select('.tooltip2').text('UTC TimeZone');

               })
                .on('mouseenter', function (d) {
                    var not_area = svg.selectAll('.country');
                    not_area.classed('grey', true);
                    d3.select(this).classed('grey', false).style('fill', 'green');
                    d3.select('.tooltip2').text(d.properties.Name);
                    data = fields(d.properties.Name.replace(/[A-Za-z ]/g, "").float());
                    render(data);
                })
                //tooltips
                .on("mousemove", function(d, i) {
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                        return parseInt(d);
                    });

                    tooltip.classed('hidden', false)
                        .attr("style", "left:" + (mouse[0] + 350) + 'px;top:' +
                            (mouse[1] - 40) + "px")
                        .html(d.properties.Name);
                });

            // Table

            var table = d3.select('body')
                .append('table');
            var thead = table.append("thead");
            var tbody = table.append("tbody");

            String.prototype.float = function() {
                return parseFloat(this);
            }
            new_dic.sort(function(a, b) {
                    return a.float() - b.float();
                })
                // console.log(new_dic);
            var dict1 = new_dic.slice(0, 14);
            var dict2 = new_dic.slice(14, 29);

            thead.append('tr')
                .selectAll('th')
                .data(['Value', 'Color'])
                .enter()
                .append('th')
                .text(function(d) {
                    return d;
                });

            var tr = tbody.selectAll('tr')
                .data(dict1)
                .enter()
                .append('tr')
                .attr('class', function(d) {
                    return 'color_' + color(d).slice(1, 7);
                });

            tr.append('td')
                .text(function(d) {
                    return d;
                });

            tr.append('td')
                .style('background', function(d) {
                    return color(d);
                })
                .style('color', '#000')
                .text(function(d) {
                    return color(d);
                });


            var table2 = d3.select('body')
                .append('table');
            var thead2 = table2.append("thead");
            var tbody2 = table2.append("tbody");

            thead2.append('tr')
                .selectAll('th')
                .data(['Value', 'Color'])
                .enter()
                .append('th')
                .text(function(d) {
                    return d;
                });
            var tr = tbody2.selectAll('tr')
                .data(dict2)
                .enter()
                .append('tr')
                .attr('class', function(d) {
                    return 'color_' + color(d).slice(1, 7);
                });

            tr.append('td')
                .text(function(d) {
                    return d;
                });

            tr.append('td')
                .style('background', function(d) {
                    return color(d);
                })
                .style('color', '#000')
                .text(function(d) {
                    return color(d);
                });

            $('tbody tr').hover(function() {
                cl = $(this).attr('class');
                // d3.selectAll('.'+cl)
                //     .classed('active2', true);
                $('.' + cl).each(function() {
                    $(this).addClass('active');
                })
            }, function() {
                $('.' + cl).each(function() {
                    $(this).removeClass('active');
                })
            });

            var tr = d3.selectAll('tbody tr');
            tr
                .on('mouseover', function () {
                    var clas = $(this).attr('class');
                    // console.log(clas.split(' ')[0]);
                    var not_area = svg.selectAll('.country');
                    var area = svg.selectAll('.'+clas.split(' ')[0]);
                    not_area.classed('grey', true);
                    area.classed('grey', false).style('fill', 'green');
                })
                .on('mouseout', function () {
                    var clas = $(this).attr('class');
                    var area = svg.selectAll('.'+clas.split(' ')[0]);
                    var not_area = svg.selectAll('.country');
                    not_area.classed('grey', false);

                    area.style('fill', '#' + clas.split('_')[1]);
                });

            //Clock
            console.log(Date());
            var fields;
            fields = function(d) {
                var currentTime, hour, minute, second;
                currentTime = new Date();
                second = currentTime.getSeconds();
                minute = currentTime.getMinutes() + second / 60;
                hour = currentTime.getHours() + minute / 60;
                return data = [{
                    "unit": "seconds",
                    "numeric": second
                }, {
                    "unit": "minutes",
                    "numeric": minute
                }, {
                    "unit": "hours",
                    "numeric": hour
                }];
            }
            var width, height, offSetX, offSetY, pi, scaleSecs, scaleMins, scaleHours;
            width = 300;
            height = 600;
            offSetX = 150;
            offSetY = 150;

            pi = Math.PI;
            scaleSecs = d3.scale.linear().domain([0, 59 + 999 / 1000]).range([0, 2 * pi]);
            scaleMins = d3.scale.linear().domain([0, 59 + 59 / 60]).range([0, 2 * pi]);
            scaleHours = d3.scale.linear().domain([0, 11 + 59 / 60]).range([0, 2 * pi]);

            tickDomain = d3.scale.linear().domain([0, 11 + 59/60]).range([0, 2*pi]);
            tickDomainInner = d3.scale.linear().domain([0, 59 + 59/60]).range([0, 2*pi]);
            var vis, clockGroup, textGroup, tooltip2;


            vis = d3.selectAll("body")
                .append("svg:svg")
                .attr("width", width)
                .attr("height", height);

            tooltip2 = vis.append('svg:g')
                .attr("transform", "translate(" + offSetX + "," + (offSetY+150) + ")");

            tooltip2.selectAll('text')
                .data([text_timezone])
                .enter()
                .append('text')
                .attr('class', 'tooltip2')
                .text(function (d) {
                    return d;
                })
                .attr("text-anchor", "middle");

            clockGroup = vis.append("svg:g")
                .attr("transform", "translate(" + offSetX + "," + offSetY + ")");

            textGroup = vis.append('svg:g')
                .attr("transform", "translate(" + (offSetX) + "," + (offSetY+170) + ")");

            clockGroup.append("svg:circle")
                .attr("r", 120).attr("fill", "none")
                .attr("class", "clock outercircle")
                .attr("stroke", "black")
                .attr("stroke-width", 2);

            clockGroup.append("svg:circle")
                .attr("r", 6).attr("fill", "black")
                .attr("class", "clock innercircle")

            var ticks = d3.svg.arc()
                .innerRadius(105)
                .outerRadius(120)
                .startAngle(function(d) {
                    return tickDomain(d);
                })
                .endAngle(function(d) {
                    return tickDomain(d);
                });

            var ticksInner = d3.svg.arc()
                .innerRadius(115)
                .outerRadius(120)
                .startAngle(function(d) {
                    return tickDomainInner(d);
                })
                .endAngle(function(d) {
                    return tickDomainInner(d);
                });

            clockGroup.selectAll('.ticks')
                .data([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11])
                .enter()
                .append("svg:path")
                .attr("d", function (d){
                    return ticks(d);
                })
                .attr('class', 'ticks')
                .attr('stroke', 'black')
                .attr('fill', 'none');

            innerTicksData = [];
            for (var i = 0; i <= 59; i++) {
                innerTicksData.push(i);
            }
            clockGroup.selectAll('.ticksInner')
                .data(innerTicksData)
                .enter()
                .append("svg:path")
                .attr("d", function (d){
                    return ticksInner(d);
                })
                .attr('class', 'ticksInner')
                .attr('stroke', 'grey')
                .attr('fill', 'none');


            var render;
            render = function(data) {
                var hourArc, minuteArc, secondArc;

                clockGroup.selectAll(".clockhand").remove();

                secondArc = d3.svg.arc()
                    .innerRadius(0)
                    .outerRadius(108)
                    .startAngle(function(d) {
                        return scaleSecs(d.numeric);
                    })
                    .endAngle(function(d) {
                        return scaleSecs(d.numeric);
                    });
                minuteArc = d3.svg.arc()
                    .innerRadius(0)
                    .outerRadius(108)
                    .startAngle(function(d) {
                        return scaleMins(d.numeric);
                    })
                    .endAngle(function(d) {
                        return scaleMins(d.numeric);
                    });

                hourArc = d3.svg.arc()
                    .innerRadius(0)
                    .outerRadius(80)
                    .startAngle(function(d) {
                        return scaleHours(d.numeric % 12);
                    })
                    .endAngle(function(d) {
                        return scaleHours(d.numeric % 12);
                    });

                clockGroup.selectAll(".clockhand")
                    .data(data)
                    .enter()
                    .append("svg:path")
                    .attr("d", function(d) {
                        if (d.unit === "seconds") {
                            return secondArc(d);
                        } else if (d.unit === "minutes") {
                            return minuteArc(d);
                        } else if (d.unit === "hours") {
                            return hourArc(d);
                        }
                    })
                    .attr("class", "clockhand")
                    .attr("stroke", "black")
                    .attr("stroke-width", function(d) {
                        if (d.unit === "seconds") {
                            return 2;
                        } else if (d.unit === "minutes") {
                            return 4;
                        } else if (d.unit === "hours") {
                            return 4;
                        }
                    })
                    .attr("fill", "none");
                var timeText = function(d){
                    time = Math.floor(d[2].numeric) + ':' +
                        Math.floor(d[1].numeric) + ':' +
                        Math.round(d[0].numeric);
                    return time;
                }
                console.log(timeText(data));
                textGroup.selectAll('text')
                    .remove();
                textGroup.selectAll('text')
                    .data(data)
                    .enter()
                    .append("text")
                    .text(
                    function (d) {
                        return timeText(data);
                    })
                    .attr("text-anchor", "middle");
            };
            var data;

            setInterval ( function() {
                data = fields();
                return render(data);
            }, 1000);
        });
    </script>
</body>

</html>
